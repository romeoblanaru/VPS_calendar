# Nchan configuration for booking events
# This file should be included in your main nginx site config
# It adds new locations without affecting existing ones

# Publisher endpoint - Only accessible from localhost and server IP
location = /internal/publish/booking {
    nchan_publisher;
    nchan_channel_id $arg_channel;
    nchan_store_messages on;
    nchan_message_timeout 5m;
    
    # Security: Only PHP can publish
    allow 127.0.0.1;
    allow ::1;
    allow 144.91.96.97;  # Server's own IP
    deny all;
}

# SSE subscriber endpoints - Public facing
location ~ ^/realtime/events/(specialist|workpoint)/(\d+)$ {
    nchan_subscriber eventsource;
    nchan_channel_id $1_$2;
    
    # CORS headers if needed
    add_header 'Access-Control-Allow-Origin' '$http_origin' always;
    add_header 'Access-Control-Allow-Credentials' 'true' always;
    add_header 'Cache-Control' 'no-cache';
    
    # Nchan SSE settings
    nchan_subscriber_timeout 3600; # 1 hour timeout
    nchan_eventsource_ping_interval 30; # 30 second keepalive
}

# Admin subscriber endpoint
location = /realtime/events/admin/all {
    nchan_subscriber eventsource;
    nchan_channel_id admin_all;
    
    # CORS headers if needed
    add_header 'Access-Control-Allow-Origin' '$http_origin' always;
    add_header 'Access-Control-Allow-Credentials' 'true' always;
    add_header 'Cache-Control' 'no-cache';
    
    # Nchan SSE settings
    nchan_subscriber_timeout 3600; # 1 hour timeout
    nchan_eventsource_ping_interval 30; # 30 second keepalive
}

# Optional: Stats endpoint for monitoring
location = /internal/nchan/stats {
    nchan_stub_status;
    allow 127.0.0.1;
    deny all;
}