# Internal HTTP server for nchan publishing
# This server block listens only on localhost port 80 to provide a fast,
# reliable endpoint for the PHP worker to publish events without
# going through HTTPS/HTTP2 which can cause timeout issues

server {
    listen 127.0.0.1:80;
    server_name localhost;

    # Publisher endpoint - Only accessible from localhost
    location = /internal/publish/booking {
        nchan_publisher;
        nchan_channel_id $arg_channel;
        nchan_store_messages on;
        nchan_message_timeout 5m;

        # Only localhost can publish
        allow 127.0.0.1;
        deny all;
    }

    # Stats endpoint for monitoring
    location = /internal/nchan/stats {
        nchan_stub_status;
        allow 127.0.0.1;
        deny all;
    }

    # Deny all other requests
    location / {
        deny all;
    }
}
